var city = {
  cityCode: [],
  city: [],
  detailInfo: '',
  customItem: '全部'
}
var role = ''
var user = {
  tel: '',
  name: '',
  flag: 0
}
var config = getApp().config;
var addId = ''
Page({
  data: {
    region: city,
    user: user,
    picHost: config.picHost
  },
  onShow:function(){
    this.setData({
      region: city,
      user: user,
    })
  },
  onLoad: function (options) {
    role = options.role ? options.role : 'receiver'
  },
  getAddress: function () {
    wx.chooseAddress({
      success: res => {
        city.city[0] = res.provinceName
        city.city[1] = res.cityName
        city.city[2] = res.countyName
        city.cityCode.push(res.nationalCode.substring(0, 2) + '0000', res.nationalCode.substring(0, 4) + '00', res.nationalCode)
        city.detailInfo = res.detailInfo
        user.tel = res.telNumber
        user.name = res.userName
        user.flag = 1
        this.setData({
          region: city,
          user: user
        })
      }
    })
  },
  bindRegionChange: function (e) {
    var val = e.detail.value
    if (val[0] == '全部' || val[1] == '全部' || val[2] == '全部') {
      var err = val[2] == '全部' ? '区县' : ''
      err = val[1] == '全部' ? '市' : err
      err = val[0] == '全部' ? '省' : err
      wx.showToast({
        title: '请选择' + err,
        icon: 'none',
        duration: 1000,
        mask: true,
      })
    } else {
      city.cityCode = e.detail.cityCode
      city.city = val
      city.detailInfo = ''
      user.flag =
        this.setData({
          region: city
        })
    }

  },
  openLoc: function () {
    var postData = {}
    postData.city = {}
    wx.chooseLocation({
      success: res => {
        city.detailInfo = res.name
        postData.city.lon = res.longitude
        postData.city.lat = res.latitude
        wx.request({
          url: config.server + '/api/getLoc',
          data: postData,
          header: {
            'Content-Type': 'application/json'
          },
          method: 'POST',
          dataType: 'json',
          responseType: 'text',
          success: res => {
            user.flag = user.name && user.tel ? 1 : 0
            city.city = res.data.body.city
            city.cityCode = res.data.body.cityCode
            this.setData({
              region: city,
              user: user
            })
          }
        })
      },
    })
  },
  getInfo: function (e) {
    var data = e.currentTarget.dataset
    if (data.info == 'area') {
      city.detailInfo = e.detail.value
      this.setData({
        region: city
      })
    } else if (data.info == 'user') {
      user.tel = data.detail == 'tel' ? e.detail.value : user.tel
      user.name = data.detail == 'name' ? e.detail.value : user.name
    }
    user.flag = user.tel && user.name && city.detailInfo && city.city.length == 3 ? 1 : 0
    this.setData({
      user: user
    })

  },
  saveInfo: function () {
    if (user.flag) {
      var postData = {}
      postData.sor = role == 'receiver' ? -1 : 1
      postData.mobile = user.tel.replace(/-/g, '');
      postData.name = user.name
      postData.areaDetail = city.detailInfo
      postData.provinceName = city.city[0]
      postData.cityName = city.city[1]
      postData.expAreaName = city.city[2]
      postData.provinceCode = city.cityCode[0]
      postData.cityCode = city.cityCode[1]
      postData.areaCode = city.cityCode[2]
      postData.uid = wx.getStorageSync('openId')
      wx.request({
        url: config.server + '/api/saveUserCityInfo',
        data: postData,
        header: {
          'Content-Type': 'application/json'
        },
        method: 'POST',
        dataType: 'json',
        responseType: 'text',
        success: res => {
          city = {
            cityCode: [],
            city: [],
            detailInfo: '',
            customItem: '全部'
          }
          user = {
            tel: '',
            name: '',
            flag: 0
          }
          addId = !res.data.errorCode?res.data.body.address_id:''
          postData.addId = addId
          var pages = getCurrentPages();             //  获取页面栈
          var currPage = pages[pages.length - 1];    // 当前页面
          var prevPage = pages[pages.length - 2];
          var that = this;  // 上一个页面
          prevPage.setData({
            mydata: postData,
          })
          wx.navigateBack({
            delta: 1,
          })
        }
      })
    }
  }
})





























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































